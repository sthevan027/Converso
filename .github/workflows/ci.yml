name: CI

on:
  pull_request:
  push:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Checks (Python ${{ matrix.python-version }} • ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install ruff mypy

      - name: Dependency sanity check
        run: python -m pip check

      - name: Lint (ruff)
        run: ruff check . --select F,E9 --target-version py312

      - name: Type-check (mypy)
        run: mypy conversor.py conversores gui utils --ignore-missing-imports

      - name: Tests (pytest)
        run: python -c "import sys, pytest; rc=pytest.main(['-q']); sys.exit(0 if rc in (0,5) else rc)"

      - name: Smoke (CLI help)
        run: python conversor.py --help

  notify_pr:
    name: Notify PR on failure
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.event_name == 'pull_request' && needs.ci.result == 'failure' && github.event.pull_request.head.repo.fork == false
    permissions:
      pull-requests: write
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: [
                'CI falhou para este PR.',
                '',
                `- Run: ${runUrl}`,
                `- Commit: ${context.sha}`,
              ].join('\n'),
            });

  create_issue_on_failure:
    name: Create issue on main failure
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.ci.result == 'failure'
    permissions:
      issues: write
      contents: read
    steps:
      - name: Open issue
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const shortSha = context.sha.substring(0, 7);
            const title = `CI falhou no main (${shortSha})`;
            const labelName = 'ci-failure';

            // Garantir que o label exista (para não falhar na criação da issue).
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
              });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                  color: 'B60205',
                  description: 'Falhas do CI no branch main',
                });
              } else {
                throw e;
              }
            }

            // Evitar spam: não criar outra issue com o mesmo título.
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: labelName,
              per_page: 100,
            });

            if (issues.some((i) => i.title === title)) {
              core.info(`Issue já existe: ${title}`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              labels: [labelName],
              body: [
                'O CI falhou em um push para `main`.',
                '',
                `- Run: ${runUrl}`,
                `- Commit: ${context.sha}`,
                `- Workflow: ${context.workflow}`,
                '',
                'Abra o run acima para ver logs, stacktraces e qual job falhou.',
              ].join('\n'),
            });

